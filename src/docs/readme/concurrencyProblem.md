# 💩 e-commerce 에서 발생할 수 있는 동시성 문제

> 나의 시나리오에서 발생할 수 있는 동시성 이슈에 대해 파악하고 가능한 동시성 제어 방식들을 도입해보고 각각의 장단점을 파악한 내용을 정리 제출

### 시나리오에서 발생할 수 있는 동시성 이슈
1. 잔액 충전 및 사용
2. 재고 차감 및 복원

#### DB의 동시성 문제 **[Uncommitted Dependency]**
#### **[초기 데이터]**

![initData](/src/docs/images/initData.png)

#### **[과정]**

![process](/src/docs/images/process.png)

#### **[결과]**

![result](/src/docs/images/result.png)



### 동시성 제어 방식들을 도입
- 비관락은 충돌이 자주 발생할 상황에 사용될 수 있다. 종류에는 s-lock (읽기 락), x-lock(쓰기 락)이 있다.
- 낙관락은 충돌이 자주 발생하지 않는 상황에서 version이라는 것을 조회하여 변경을 감지 후(트랜젝션 롤백이 일어남) retry등을 이용해 동시성을 처리할 수 있다.
- DB락을 사용했을 경우 DB의 transaction isolation level 에 따라 phantom read, Non-Repeatable Read 문제가 발생할 수 있다.
- 잔액 충전 및 사용은 낙관락을 사용할 수 있다. (비교적 충돌이 자주 발생하지 않음)
- 재고 차감 및 복원은 x-lock을 사용할 수 있다. (한정된 자원을 여러명이서 경쟁을 해야하기 때문에 충돌이 빈번이 일어난다.)

### 각각의 장단점을 파악
| **구분** | **비관락** | **낙관락** | **레디스** |
|:------:|:-------:|:-------:|:-------:|
|구현의 복잡도 |   낮음    |   중간    | 서버 올려야함 |
|   성능   |   중간    |   낮음    |   높음    |
|  효율성   |   중간    |   낮음    | 활용도가 높다 |

### 비관락과 낙관락 성능 비교 및 느낀점
> 테스트를 해보면서 충돌이 자주 일어나는 곳에는 낙관락을 사용하면 안된다는 걸 알았다. 물론 비관락도 엄청난 트래픽이 
> 발생한 경우를 테스트 해본것은 아니지만, 1000번 까지는 비관락이 낙관락 보다 성능이 좋다고 판단된다.
> 또한, 낙관락의 경우 retry를 하기위해 spring-retry를 추가하였고, @version을 추가하는 등 어려운건 아니지만 비관락보다
> 귀찮은 부분이 있다.
> 
> 콘서트 예약에서는 좌석 예약시 retry이 없이 낙관락을 사용할 수 있었을 텐데 이런 경험을 직접적으로 하지 못해 아쉽다.

![vsLock](/src/docs/images/vsLock.png)